!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.nixSdk={})}(this,function(e){const t=function(){function e(){}return e.prototype.then=function(t,n){const o=new e,i=this.s;if(i){const e=1&i?t:n;if(e){try{r(o,1,e(this.v))}catch(e){r(o,2,e)}return o}return this}return this.o=function(e){try{const i=e.v;1&e.s?r(o,1,t?t(i):i):n?r(o,1,n(i)):r(o,2,i)}catch(e){r(o,2,e)}},o},e}();function r(e,n,o){if(!e.s){if(o instanceof t){if(!o.s)return void(o.o=r.bind(null,e,n));1&n&&(n=o.s),o=o.v}if(o&&o.then)return void o.then(r.bind(null,e,n),r.bind(null,e,2));e.s=n,e.v=o;const i=e.o;i&&i(e)}}function n(e){return e instanceof t&&1&e.s}function o(e,o,i){var s,u,c=-1;return function a(l){try{for(;++c<e.length&&(!i||!i());)if((l=o(c))&&l.then){if(!n(l))return void l.then(a,u||(u=r.bind(null,s=new t,2)));l=l.v}s?r(s,1,l):s=l}catch(e){r(s||(s=new t),2,e)}}(),s}function i(e,t,r){var n=[];for(var i in e)n.push(i);return o(n,function(e){return t(n[e])},r)}function s(e,o,i){for(var s;;){var u=e();if(n(u)&&(u=u.v),!u)return c;if(u.then){s=0;break}var c=i();if(c&&c.then){if(!n(c)){s=1;break}c=c.s}if(o){var a=o();if(a&&a.then&&!n(a)){s=2;break}}}var l=new t,y=r.bind(null,l,2);return(0===s?u.then(f):1===s?c.then(d):a.then(h)).then(void 0,y),l;function d(t){c=t;do{if(o&&(a=o())&&a.then&&!n(a))return void a.then(h).then(void 0,y);if(!(u=e())||n(u)&&!u.v)return void r(l,1,c);if(u.then)return void u.then(f).then(void 0,y);n(c=i())&&(c=c.v)}while(!c||!c.then);c.then(d).then(void 0,y)}function f(e){e?(c=i())&&c.then?c.then(d).then(void 0,y):d(c):r(l,1,c)}function h(){(u=e())?u.then?u.then(f).then(void 0,y):f(u):r(l,1,c)}}function u(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var c="",a="app",l="group",y="route",d="user",f="vault",h=8,v={Signed:"s",Encrypted:"e",Request:"r",Publish:"p",Clear:"c"},m={ContentPkgRead:"pr",ContentPkgWrite:"pw",ContentPkgControl:"pc",IdentitiesRead:"ir",IdentitiesWrite:"iw",IdentitiesControl:"ic",VaultRead:"vr",VaultWrite:"vw",VaultControl:"vc"},p=/(ey[0-9A-Za-z_\-]*\.[0-9A-Za-z_\-]*\.[0-9A-Za-z_\-]*\.[0-9A-Za-z_\-]*\.[0-9A-Za-z_\-]*)/g,P={IdentityTypeUnknown:c,IdentityTypeApp:a,IdentityTypeGroup:l,IdentityTypeRoute:y,IdentityTypeUser:d,IdentityTypeVault:f,KIDThumbLength:h,IdentityMsgType:v,VaultOps:m,JWERegex:p},g=function(){try{var e=new Uint8Array(16);return Promise.resolve(crypto.getRandomValues(e)).then(function(){return S(B(e))})}catch(e){return Promise.reject(e)}};function b(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))}function C(e){return b(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function k(e){return btoa(e)}function K(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_")}function S(e){return k(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function w(e){return decodeURIComponent(atob(e).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}function A(e){return w(e.replace(/-/g,"+").replace(/_/g,"/"))}function j(e){return atob(e)}function I(e){return j(e.replace(/-/g,"+").replace(/_/g,"/"))}function D(e){return E(e=encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))}function E(e){return x(e).buffer}function x(e){for(var t=new Uint8Array(e.length),r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}function M(e){var t=new Uint8Array(e.length+4);t[0]=e.length>>>24&255,t[1]=e.length>>>16&255,t[2]=e.length>>>8&255,t[3]=e.length>>>0&255;for(var r=0;r<e.length;r++)t[r+4]=e.charCodeAt(r);return t}function T(e){return new Promise(function(t,r){r(e)})}function O(e){return new Promise(function(t,r){t(e)})}function J(e){return"EC"!==e.kty||"P-256"!==e.crv?T("unsupported key - only ES256 - "+e.kty+" "+e.crv):crypto.subtle.digest({name:"SHA-256"},E('{"crv":"P-256","kty":"EC","x":"'+e.x+'","y":"'+e.y+'"}')).then(function(e){return K(B(e))})}function B(e){for(var t="",r=new Uint8Array(e),n=r.byteLength,o=0;o<n;o++)t+=String.fromCharCode(r[o]);return t}function R(e){return decodeURIComponent(B(e).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}function L(e){var t="",r="",n="",o=e.indexOf("/"),i=e;o>=0&&(i=e.slice(0,o),t=e.slice(o));var s=i.indexOf("@");return n=i,s>=0&&(n=i.slice(0,s).replace(/=/g,""),r=i.slice(s)),"@api.nix.software"===r&&(r=""),n+r+t}function N(e){var t="",r=e,n=e.indexOf("/");n>=0&&(r=e.slice(0,n),t=e.slice(n+1));var o=r.indexOf("@"),i=r,s="@api.nix.software";if(o>=0&&(i=r.slice(0,o),s=r.slice(o)),i.length&&"="!=i[i.length-1])switch(i.length-1){case 2:i+="==";break;case 3:i+="="}return[i+s,t]}function U(e){var t=e,r=e.indexOf("/");return r>=0&&(t=e.slice(r+1)),t}var G={b64UUID:g,base64EncodeStr:b,base64EncodeStrJWS:C,base64EncodeBytes:k,base64EncodeBytesURL:K,base64EncodeBytesJWS:S,base64DecodeStr:w,base64DecodeStrJWS:A,base64DecodeBytes:j,base64DecodeBytesJWS:I,strToUtf8ArrayBuf:D,strToBytes:function(e){return encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)})},bytesToUint8ArrayBuf:E,bytesToUint8Array:x,bytesToLenPrefixUint8Array:M,errPromise:T,successPromise:O,jwkThumbSHA256B64:J,arrToBytes:B,arrToStr:R,trimAddr:L,kidToCanonUserHostPath:N,kidStripHostPath:U},W=function(){this.rawCompact=null,this.headerB64=null,this.payloadB64=null,this.signatureB64=null,this.payload=null,this.alg=null,this.jwk=null,this.kid=null,this.tgt=null,this.iat=0,this.typ=null,this.cty=null};W.fromCompact=function(e){var t,r,n=new W;n.rawCompact=e,t=e.split(".",3),n.headerB64=t[0],n.payloadB64=t[1],n.signatureB64=t[2];var o=JSON.parse(A(n.headerB64));return n.alg=(r=[o.alg,o.jwk,o.kid,o.tgt,o.iat,o.typ,o.cty])[0],n.jwk=r[1],n.kid=r[2],n.tgt=r[3],n.iat=r[4],n.typ=r[5],n.cty=r[6],n},W.forJSONPayload=function(e){var t=new W;return t.payload=e,t},W.forValuePayload=function(e){return W.forJSONPayload(JSON.stringify(e))},W.prototype.setTgtIat=function(e){return this.iat=Date.now()/1e3|0,this.tgt=e,this},W.prototype.setKID=function(e){return this.kid=e,this},W.prototype.verify=function(e){try{var t=this;if("ES256"!==t.alg)return T("unsupported alg - only ES256 supported");if("ECDSA"!==e.algorithm.name||"P-256"!==e.algorithm.namedCurve)return T("unsupported key - only ES256 - "+JSON.stringify(e.algorithm));var r=E(t.headerB64+"."+t.payloadB64);return Promise.resolve(crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},e,E(I(t.signatureB64)),r).then(function(e){return e?O(t.UNSAFEExtractPayload()):T("signature invalid for "+JSON.stringify(t))}).catch(function(e){return T(e)}))}catch(e){return Promise.reject(e)}},W.prototype.toLogFormat=function(){return{payload:JSON.parse(A(this.payloadB64)),protected:JSON.parse(A(this.headerB64)),signature:this.signatureB64}},W.prototype.UNSAFEExtractPayload=function(){return A(this.payloadB64)},W.prototype.toCompactECDSAP256=function(e){try{var t=this;if("ECDSA"!==e.algorithm.name||"P-256"!==e.algorithm.namedCurve)return T("unsupported key - only ES256 - "+JSON.stringify(e.algorithm));t.alg="ES256";var r={alg:t.alg,jwk:t.jwk,kid:t.kid,tgt:t.tgt,iat:t.iat,typ:t.typ,cty:t.cty};Object.keys(r).forEach(function(e){return!r[e]&&void 0!==!r[e]&&delete r[e]}),t.headerB64=C(JSON.stringify(r)),t.payloadB64=C(t.payload);var n=E(t.headerB64+"."+t.payloadB64);return Promise.resolve(crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},e,n)).then(function(e){return t.signatureB64=S(B(e)),[t.headerB64,t.payloadB64,t.signatureB64].join(".")})}catch(e){return Promise.reject(e)}};var H=function(){};H.toECDSAP256Pub=function(e){try{return delete(e=Object.assign({},e)).use,delete e.d,Promise.resolve(crypto.subtle.importKey("jwk",e,{name:"ECDSA",namedCurve:"P-256"},!0,["verify"]))}catch(e){return Promise.reject(e)}},H.toECDSAP256Priv=function(e){try{return delete(e=Object.assign({},e)).use,crypto.subtle.importKey("jwk",e,{name:"ECDSA",namedCurve:"P-256"},!0,["sign"])}catch(e){return Promise.reject(e)}},H.toECDHP256Pub=function(e){try{return delete(e=Object.assign({},e)).use,delete e.d,Promise.resolve(crypto.subtle.importKey("jwk",e,{name:"ECDH",namedCurve:"P-256"},!0,[]))}catch(e){return Promise.reject(e)}},H.toECDHP256Priv=function(e){try{return delete(e=Object.assign({},e)).use,Promise.resolve(crypto.subtle.importKey("jwk",e,{name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]))}catch(e){return Promise.reject(e)}},H.toAESGCMKey=function(e){try{return delete(e=Object.assign({},e)).use,Promise.resolve(crypto.subtle.importKey("jwk",e,{name:"AES-GCM"},!0,["encrypt","decrypt"]))}catch(e){return Promise.reject(e)}},H.randomAESGCM=function(){try{var e=crypto.getRandomValues(new Uint8Array(32)),t=crypto.subtle,r=t.exportKey;return Promise.resolve(crypto.subtle.importKey("raw",e,"AES-GCM",!0,["encrypt","decrypt"])).then(function(e){return r.call(t,"jwk",e)})}catch(e){return Promise.reject(e)}},H.fromECDSAP256Pub=function(e){try{return Promise.resolve(crypto.subtle.exportKey("jwk",e)).then(function(e){return delete e.d,delete e.ext,delete e.key_ops,e.use="sig",Promise.resolve(J(e)).then(function(t){return e.kid=t,e})})}catch(e){return Promise.reject(e)}},H.fromECDSAP256Priv=function(e){try{return Promise.resolve(crypto.subtle.exportKey("jwk",e)).then(function(e){return delete e.ext,delete e.key_ops,e.use="sig",Promise.resolve(J(e)).then(function(t){return e.kid=t,e})})}catch(e){return Promise.reject(e)}},H.fromECDHP256Pub=function(e){try{return Promise.resolve(crypto.subtle.exportKey("jwk",e)).then(function(e){return delete e.d,delete e.ext,delete e.key_ops,e.use="enc",Promise.resolve(J(e)).then(function(t){return e.kid=t,e})})}catch(e){return Promise.reject(e)}},H.fromECDHP256Priv=function(e){try{return Promise.resolve(crypto.subtle.exportKey("jwk",e)).then(function(e){return delete e.ext,delete e.key_ops,e.use="enc",Promise.resolve(J(e)).then(function(t){return e.kid=t,e})})}catch(e){return Promise.reject(e)}};var F=function(){this.protectedB64=null,this.encryptedKey=null,this.iv=null,this.cipherText=null,this.tag=null,this.protectedObj=null};F.prototype.getProtected=function(){return JSON.parse(A(this.protectedB64))},F.fromCompact=function(e){var t=new F,r=e.split(".",5);return t.protectedB64=r[0],t.iv=E(I(r[2])),t.cipherText=E(I(r[3])),t.tag=E(I(r[4])),t},F.prototype.toLogFormat=function(e){return{payload:e,protected:JSON.parse(A(this.protectedB64))}},F.encryptECDHESP256=function(e,t,r,n){try{var o=this,i=new F;if("ECDH"!==e.algorithm.name||"P-256"!==e.algorithm.namedCurve)throw"unsupported key - only ECDH-ES P-256- "+JSON.stringify(e.algorithm);return Promise.resolve(crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"])).then(function(s){return Promise.resolve(crypto.subtle.exportKey("jwk",s.publicKey)).then(function(u){return delete u.ext,delete u.key_ops,u.use="enc",(n=n||{}).alg="ECDH-ES",n.enc="A256GCM",n.epk=u,r&&(n.kid=r),o.protectedObj=n,i.protectedB64=C(JSON.stringify(n)),Promise.resolve(crypto.subtle.deriveKey({name:"ECDH",namedCurve:"P-256",public:e},s.privateKey,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])).then(function(e){return Promise.resolve(F.deriveKeyConcatKDFSHA256("A256GCM","","",e)).then(function(r){return e=r,Promise.resolve(crypto.getRandomValues(new Uint8Array(12))).then(function(r){return i.iv=r,Promise.resolve(crypto.subtle.encrypt({name:"AES-GCM",iv:i.iv,additionalData:E(i.protectedB64),tagLength:128},e,D(t))).then(function(e){return i.cipherText=new Uint8Array(e),i.tag=i.cipherText.slice(i.cipherText.byteLength-16),i.cipherText=i.cipherText.slice(0,i.cipherText.byteLength-16),i})})})})})})}catch(e){return Promise.reject(e)}},F.encryptPBKDF2AES256GCM=function(e,t,r,n,o){try{var i=F.encryptDirectAES256GCM;return Promise.resolve(F.pbkdf2(e,t)).then(function(e){return Promise.resolve(i.call(F,e,r,n,o))})}catch(e){return Promise.reject(e)}},F.encryptDirectAES256GCM=function(e,t,r,n){try{var o=this;function i(){if("AES-GCM"!==e.algorithm.name||256!==e.algorithm.length)throw"unsupported key - only AES-GCM 256 - "+JSON.stringify(e.algorithm);return(n=n||{}).alg="dir",n.enc="A256GCM",r&&(n.kid=r),o.protectedObj=n,s.protectedB64=C(JSON.stringify(n)),Promise.resolve(crypto.getRandomValues(new Uint8Array(12))).then(function(r){return s.iv=r,Promise.resolve(crypto.subtle.encrypt({name:"AES-GCM",iv:s.iv,additionalData:E(s.protectedB64),tagLength:128},e,D(t))).then(function(e){return s.cipherText=new Uint8Array(e),s.tag=s.cipherText.slice(s.cipherText.byteLength-16),s.cipherText=s.cipherText.slice(0,s.cipherText.byteLength-16),s})})}var s=new F,u=function(){if("oct"===e.kty)return Promise.resolve(H.toAESGCMKey(e)).then(function(t){e=t})}();return u&&u.then?u.then(i):i()}catch(e){return Promise.reject(e)}},F.pbkdf2=function(e,t){try{var r=crypto.subtle,n=r.deriveKey,o={name:"PBKDF2",salt:D(t),iterations:1e4,hash:{name:"SHA-256"}};return Promise.resolve(crypto.subtle.importKey("raw",D(e),{name:"PBKDF2"},!1,["deriveKey","deriveBits"])).then(function(e){return Promise.resolve(n.call(r,o,e,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]))})}catch(e){return Promise.reject(e)}},F.deriveKeyConcatKDFSHA256=function(e,t,r,n){try{e=M(e),t=M(t),r=M(r);var o=new Uint8Array(4);o[0]=0,o[1]=0,o[2]=1,o[3]=0;var i=new Uint8Array(4);return i[0]=0,i[1]=0,i[2]=0,i[3]=1,Promise.resolve(crypto.subtle.exportKey("raw",n)).then(function(s){n=new Uint8Array(s);var u=new Uint8Array(i.length+n.length+e.length+t.length+r.length+o.length),c=0;return u.set(i,c),u.set(n,c+=i.length),u.set(e,c+=n.length),u.set(t,c+=e.length),u.set(r,c+=t.length),u.set(o,c+=r.length),Promise.resolve(crypto.subtle.digest({name:"SHA-256"},u)).then(function(e){return Promise.resolve(crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!0,["encrypt","decrypt"]))})})}catch(e){return Promise.reject(e)}},F.prototype.toCompact=function(){return this.protectedB64+".."+S(B(this.iv))+"."+S(B(this.cipherText))+"."+S(B(this.tag))},F.prototype.decryptECDHEP256=function(e){try{var t=this,r=JSON.parse(A(t.protectedB64));if("ECDH-ES"!==r.alg||"A256GCM"!==r.enc)throw"unsupported alg + enc - only ECDH-ES with A256GCM - "+r.alg+" "+r.enc;return t.protectedObj=r,Promise.resolve(H.toECDHP256Pub(r.epk)).then(function(n){return Promise.resolve(crypto.subtle.deriveKey({name:"ECDH",namedCurve:"P-256",public:n},e,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])).then(function(e){var n=r.apu?I(r.apu):"",o=r.apv?I(r.apv):"";return Promise.resolve(F.deriveKeyConcatKDFSHA256("A256GCM",n,o,e)).then(function(r){e=r;var n=t.cipherText.byteLength+t.tag.byteLength,o=new Uint8Array(n);return o.set(new Uint8Array(t.cipherText),0),o.set(new Uint8Array(t.tag),n-16),Promise.resolve(crypto.subtle.decrypt({name:"AES-GCM",iv:t.iv,additionalData:E(t.protectedB64),tagLength:128},e,o)).then(R)})})})}catch(e){return Promise.reject(e)}},F.prototype.decryptPBKDF2AES256GCM=function(e,t){try{var r=this,n=r.decryptDirectAES256GCM;return Promise.resolve(F.pbkdf2(e,t)).then(function(e){return Promise.resolve(n.call(r,e))})}catch(e){return Promise.reject(e)}},F.prototype.decryptDirectAES256GCM=function(e){try{var t=this;function r(){var r=JSON.parse(A(t.protectedB64));if("dir"!==r.alg||"A256GCM"!==r.enc)throw"unsupported alg + enc - only DIRECT with A256GCM - "+r.alg+" "+r.enc;t.protectedObj=r;var n=t.cipherText.byteLength+t.tag.byteLength,o=new Uint8Array(n);return o.set(new Uint8Array(t.cipherText),0),o.set(new Uint8Array(t.tag),n-16),Promise.resolve(crypto.subtle.decrypt({name:"AES-GCM",iv:t.iv,additionalData:E(t.protectedB64),tagLength:128},e,o)).then(R)}var n=function(){if("oct"===e.kty)return Promise.resolve(H.toAESGCMKey(e)).then(function(t){e=t})}();return n&&n.then?n.then(r):r()}catch(e){return Promise.reject(e)}};var V=function(e,t,r,n){this.iss=e,this.sub=t,this.id=r,this.aud=n};V.prototype.setExpire=function(e,t){return this.iat=Date.now()/1e3|0,this.exp=this.iat+e,this.nbf=this.iat-t,this},V.prototype.withBody=function(e){for(var t in e)this[t]=e[t];return this};var q=function(e){for(var t in e)this[t]=e[t]};q.prototype.isError=function(){return null==this.status||this.status<200||this.status>=400};var _=function(e,t,r,n,o){this.type=e,this.id=t,this.dst=r,this.exp=n,this.body=o,this.srcAddr="",this.srcKeyAddr="",this.kid=""};_.fromObj=function(e){var t=new _;for(var r in e)t[r]=e[r];return t},_.prototype.toCompactECDSAP256=function(e,t){return W.forValuePayload({type:this.type,id:this.id,dst:this.dst,exp:this.exp,body:this.body}).setKID(e).toCompactECDSAP256(t)};var z=function(e){if(this.identityType="",this.name="",this.clientType="Web",this.version="v1.0.0.1",this.tags={},this.appAddress="",e)for(var t in e)this[t]=e[t]},Z=function(e){if(this.comms=[],this.tags={},this.created=0,this.lastHeardDay=0,e)for(var t in e)this[t]=e[t]},$=!1,Q=!1,X=!0,Y=function(e){void 0===e&&(e={});var t=e.apiKeyID;void 0===t&&(t=null);var r=e.apiKeySecret;void 0===r&&(r=null);var n=e.apiKeyJWTAuth;void 0===n&&(n=null);var o=e.nixURL;void 0===o&&(o="https://api.nix.software"),this.nixHost="",this.nixURL=o||"https://api.nix.software",this.apiKeyID=t,this.apiKeySecret=r||n,this.address=null,this.reconnectID=""+Date.now(),this.sigPubKey=null,this.sigPrivKey=null,this.encPubKey=null,this.encPrivKey=null,this.defaultTTLSec=604800,this.nextIDUniq=0,this.metaPublic=new z,this.metaPrivate=new Z,this.autoFetch=!0,this.knownKeys={},this.keyStore=null},ee={nixURL:{configurable:!0}};Y.prototype.import=function(e,t,r,n,o){try{var i=this;return i.metaPublic.identityType=e,i.address=t,Promise.resolve(H.toECDSAP256Priv(r)).then(function(e){return i.sigPrivKey=e,Promise.resolve(H.toECDSAP256Pub(r)).then(function(e){return i.sigPubKey=e,Promise.resolve(H.toECDHP256Priv(n)).then(function(e){return i.encPrivKey=e,Promise.resolve(H.toECDHP256Pub(n)).then(function(e){if(i.encPubKey=e,!o)return Promise.resolve(i.fetchMe())})})})})}catch(e){return Promise.reject(e)}},Y.prototype.reqRaw=function(e,t,r){try{var n=this.apiKeyID?"Basic "+btoa(this.apiKeyID+":"+this.apiKeySecret):"Bearer "+this.apiKeySecret;return fetch(""+this._nixURL+t,{method:e,cache:"no-cache",headers:{"Content-Type":"application/json",Authorization:n},redirect:"follow",body:r?JSON.stringify(r):void 0})}catch(e){return Promise.reject(e)}},Y.prototype.req=function(e,t,r){try{return this.reqRaw(e,t,r).then(function(e){return e.json()})}catch(e){return Promise.reject(e)}},ee.nixURL.set=function(e){this._nixURL=e.replace(/\/+$/,""),this.nixHost=new URL(this._nixURL).hostname},Y.prototype.register=function(e){try{var t=this;function r(){function e(){return Promise.resolve(H.fromECDSAP256Pub(t.sigPubKey)).then(function(e){var r="/"+e.kid;return Promise.resolve(H.fromECDHP256Pub(t.encPubKey)).then(function(o){return Promise.resolve(W.forValuePayload(o).setTgtIat(n+"#encPubKey").setKID(r).toCompactECDSAP256(t.sigPrivKey)).then(function(o){return Promise.resolve(W.forValuePayload(t.metaPublic).setTgtIat(n+"#metaPublic").setKID(r).toCompactECDSAP256(t.sigPrivKey)).then(function(i){return Promise.resolve(W.forValuePayload(t.metaPrivate).setTgtIat(n+"#metaPrivate").setKID(r).toCompactECDSAP256(t.sigPrivKey)).then(function(r){return Promise.resolve(t.req("POST",n,{sigPubKey:e,encPubKey:o,metaPublic:i,metaPrivate:r})).then(function(e){var r=new q(e);return r.isError()?r:(t.address=r.body.address,r)})})})})})})}var r=function(){if(!t.encPrivKey)return Promise.resolve(crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"])).then(function(e){t.encPrivKey=e.privateKey,t.encPubKey=e.publicKey})}();return r&&r.then?r.then(e):e()}var n="/v1/identity";e&&(t.metaPublic.identityType=e);var o=function(){if(!t.sigPrivKey)return Promise.resolve(crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign"])).then(function(e){t.sigPrivKey=e.privateKey,t.sigPubKey=e.publicKey})}();return o&&o.then?o.then(r):r()}catch(e){return Promise.reject(e)}},Y.prototype.curSigKID=function(){try{var e=this;return Promise.resolve(crypto.subtle.exportKey("jwk",e.sigPubKey)).then(function(t){return Promise.resolve(J(t)).then(function(t){return e.address+"/"+t})})}catch(e){return Promise.reject(e)}},Y.prototype.recover=function(e,t,r){try{var n=this;return Promise.resolve(n.fetchRecovery(e,r)).then(function(r){if(r.isError())throw"couldn't fetch recovery - "+JSON.stringify(recover);return Promise.resolve(F.fromCompact(JSON.parse(W.fromCompact(r.body.jws).UNSAFEExtractPayload()).jwe).decryptPBKDF2AES256GCM(t,e)).then(function(e){var t=JSON.parse(e);return Promise.resolve(n.import(t.type,t.address,t.sigPrivKey,t.encPrivKey)).then(function(){return n.autoFetch=t.autoFetch,Promise.resolve(n.fetchMe())})})})}catch(e){return Promise.reject(e)}},Y.prototype.buildRecovery=function(e){try{var t=this;return Promise.resolve(H.fromECDSAP256Priv(t.sigPrivKey)).then(function(r){return Promise.resolve(H.fromECDHP256Priv(t.encPrivKey)).then(function(n){return Promise.resolve(F.encryptPBKDF2AES256GCM(e,t.address,JSON.stringify({address:t.address,type:t.metaPublic.identityType,sigPrivKey:r,encPrivKey:n,autoFetch:t.autoFetch}),""+t.address)).then(function(e){return e.toCompact()})})})}catch(e){return Promise.reject(e)}},Y.prototype.toJSONFull=function(){try{var e=this;return Promise.resolve(H.fromECDSAP256Priv(e.sigPrivKey)).then(function(t){return Promise.resolve(H.fromECDHP256Priv(e.encPrivKey)).then(function(r){return JSON.stringify({nixHost:e.nixHost,nixURL:e._nixURL,apiKeyID:e.apiKeyID,apiKeySecret:e.apiKeySecret,address:e.address,sigPrivKey:t,encPrivKey:r,autoFetch:e.autoFetch,defaultTTLSec:e.defaultTTLSec,metaPublic:e.metaPublic,metaPrivate:e.metaPrivate})})})}catch(e){return Promise.reject(e)}},Y.fromJSONFull=function(e){try{var t=JSON.parse(e),r=new Y({apiKeyID:t.apiKeyID,apiKeySecret:t.apiKeySecret,nixURL:t.nixURL});return Promise.resolve(r.import(t.metaPublic.identityType,t.address,t.sigPrivKey,t.encPrivKey,!0)).then(function(){return r.autoFetch=t.autoFetch,r.defaultTTLSec=t.defaultTTLSec,r.metaPublic=new z(t.metaPublic),r.metaPrivate=new Z(t.metaPrivate),r})}catch(e){return Promise.reject(e)}},Y.prototype.setRecovery=function(e){try{var t=this,r="/v1/identity/me/data/recovery",n=W.forValuePayload({name:"recovery",jwe:e}).setTgtIat(r+"#jws"),o=n.setKID;return Promise.resolve(t.curSigKID()).then(function(e){return Promise.resolve(o.call(n,e).toCompactECDSAP256(t.sigPrivKey)).then(function(e){return Promise.resolve(t.req("POST",r,{jws:e})).then(function(e){return new q(e)})})})}catch(e){return Promise.reject(e)}},Y.prototype.fetchRecovery=function(e,t){try{var r=this;return Promise.resolve(r.req("GET","/v1/identity/"+e+"/data/recovery",null)).then(function(n){var o=new q(n);return t?o:Promise.resolve(r.getKnownKeys(e)).then(function(e){return Promise.resolve(H.toECDSAP256Pub(e.sigPubKey)).then(function(e){return Promise.resolve(W.fromCompact(o.body.jws).verify(e)).then(function(){return o})})})})}catch(e){return Promise.reject(e)}},Y.prototype.updateSigKey=function(e,t){try{var r=this;function n(){function e(){return Promise.resolve(H.fromECDSAP256Pub(i.publicKey)).then(function(e){return Promise.resolve(H.fromECDHP256Pub(n.publicKey)).then(function(t){var s=W.forValuePayload(e).setTgtIat(o+"#sigPubKey"),u=s.setKID;return Promise.resolve(r.curSigKID()).then(function(c){return Promise.resolve(u.call(s,c).toCompactECDSAP256(r.sigPrivKey)).then(function(s){return Promise.resolve(W.forValuePayload(t).setTgtIat(o+"#encPubKey").setKID(r.address+"/"+e.kid).toCompactECDSAP256(i.privateKey)).then(function(e){return Promise.resolve(r.req("POST",o,{sigPubKey:s,encPubKey:e})).then(function(e){var t=new q(e);return t.isError()?t:(r.sigPrivKey=i.privateKey,r.sigPubKey=i.publicKey,r.encPrivKey=n.privateKey,r.encPubKey=n.publicKey,t)})})})})})})}var n={publicKey:r.encPubKey,privateKey:r.encPrivKey},s=function(){if(t)return Promise.resolve(H.toECDHP256Priv(t)).then(function(e){return Promise.resolve(H.toECDSAP256Pub(t)).then(function(t){n={privateKey:e,publicKey:t}})})}();return s&&s.then?s.then(e):e()}var o="/v1/identity/me/sigPubKey",i={},s=e?Promise.resolve(H.toECDSAP256Priv(e)).then(function(t){return Promise.resolve(H.toECDSAP256Pub(e)).then(function(e){i={privateKey:t,publicKey:e}})}):Promise.resolve(crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign"])).then(function(e){i=e});return s&&s.then?s.then(n):n()}catch(e){return Promise.reject(e)}},Y.prototype.updateEncKey=function(e){try{var t=this;function r(){return Promise.resolve(H.fromECDHP256Pub(o.publicKey)).then(function(e){var r=W.forValuePayload(e).setTgtIat(n+"#encPubKey"),i=r.setKID;return Promise.resolve(t.curSigKID()).then(function(e){return Promise.resolve(i.call(r,e).toCompactECDSAP256(t.sigPrivKey)).then(function(e){return Promise.resolve(t.req("POST",n,{encPubKey:e})).then(function(e){var r=new q(e);return r.isError()?r:(t.encPrivKey=o.privateKey,t.encPubKey=o.publicKey,r)})})})})}var n="/v1/identity/me/encPubKey",o={},i=e?Promise.resolve(H.toECDHP256Priv(e)).then(function(t){return Promise.resolve(H.toECDSAP256Pub(e)).then(function(e){o={privateKey:t,publicKey:e}})}):Promise.resolve(crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"])).then(function(e){o=e});return i&&i.then?i.then(r):r()}catch(e){return Promise.reject(e)}},Y.prototype.updateMeta=function(e,t){try{var r=this,n="/v1/identity/me/meta";return e=e||r.metaPublic,t=t||r.metaPrivate,Promise.resolve(r.curSigKID()).then(function(o){return Promise.resolve(W.forValuePayload(e).setTgtIat(n+"#metaPublic").setKID(o).toCompactECDSAP256(r.sigPrivKey)).then(function(i){return Promise.resolve(W.forValuePayload(t).setTgtIat(n+"#metaPrivate").setKID(o).toCompactECDSAP256(r.sigPrivKey)).then(function(o){return Promise.resolve(r.req("POST",n,{metaPublic:i,metaPrivate:o})).then(function(n){var o=new q(n);return o.isError()?o:(r.metaPublic=e,r.metaPrivate=t,o)})})})})}catch(e){return Promise.reject(e)}},Y.prototype.fetchIdentityPublic=function(e){try{return Promise.resolve(this.req("GET","/v1/identity/"+e,null)).then(function(e){return new q(e)})}catch(e){return Promise.reject(e)}},Y.prototype.fetchMe=function(){try{var e=this,t="/v1/identity/me",r=W.forValuePayload(new V(e.address,e.address,e.address,[e.nixHost]).setExpire(300,300)).setTgtIat(t+"#jwt"),n=r.setKID;return Promise.resolve(e.curSigKID()).then(function(o){return Promise.resolve(n.call(r,o).toCompactECDSAP256(e.sigPrivKey)).then(function(r){return Promise.resolve(e.req("POST",t,{jwt:r})).then(function(t){var r=new q(t);return r.isError()?r:(e.metaPublic=new z(r.body.metaPublic),e.metaPrivate=new Z(r.body.metaPrivate),r)})})})}catch(e){return Promise.reject(e)}},Y.prototype.getKnownKeys=function(e,t){try{var r=!1,n=this;function o(t){if(r)return t;throw"could not find keys for "+e}var i=N(e),s=i[0],u=i[1];if(s in n.knownKeys&&!0!==t){var c=n.knownKeys[s];if(!u)return c;for(var a in c.byID)if(a.startsWith(u)){var l=c.byID[a];return"sig"===l.use?{sigPubKey:l}:{encPubKey:l}}}if(n.keyStore&&!t)try{var y=n.keyStore.getKnownKeys(e);n.addKnownKeys(e,[y.sigPubKey,y.encPubKey])}catch(e){}var d=function(){if(n.autoFetch||t)return Promise.resolve(n.fetchIdentityPublic(s)).then(function(t){if(!t.isError()){var o={encPubKey:JSON.parse(W.fromCompact(t.body.encPubKey).UNSAFEExtractPayload()),sigPubKey:t.body.sigPubKey};return n.addKnownKeys(e,[o.sigPubKey,o.encPubKey]),n.keyStore&&n.keys.setKnownKeys(e,o),r=!0,o}})}();return d&&d.then?d.then(o):o(d)}catch(e){return Promise.reject(e)}},Y.prototype.addKnownKeys=function(e,t){try{var r=this,n=N(e)[0];t.map(function(e){if(e){var t=U(e.kid);r.knownKeys[n]||(r.knownKeys[n]={sigPubKey:null,encPubKey:null,byID:{}}),r.knownKeys[n].byID[t]=e,"sig"===e.use?r.knownKeys[n].sigPubKey=e:"enc"===e.use&&(r.knownKeys[n].encPubKey=e)}})}catch(e){return Promise.reject(e)}},Y.prototype.extractMessage=function(e){try{var t=this,r=W.fromCompact(e);return Promise.resolve(t.getKnownKeys(r.kid)).then(function(e){return Promise.resolve(H.toECDSAP256Pub(e.sigPubKey)).then(function(e){return Promise.resolve(r.verify(e)).then(function(e){function n(e){if(o.src=i,o.srcKID=r.kid,Q){var t=r.toLogFormat();o.body.jwe&&(t.payload.body.jwe=s.toLogFormat(o.body.jwe)),t=X?JSON.stringify(t,null,2):t,console.log("extractMessage\n",t)}return o}var o=JSON.parse(e),i=N(r.kid)[0],s=null,u=function(){if(o.body.jwe)return Promise.resolve(F.fromCompact(o.body.jwe)).then(function(e){return s=e,Promise.resolve(s.decryptECDHEP256(t.encPrivKey)).then(function(e){if(o.body.jwe=JSON.parse(e),N(o.body.jwe.src)[0]!==i)throw"JWE src doesn't match message signature kid"})})}();return u&&u.then?u.then(n):n()})})})}catch(e){return Promise.reject(e)}},Y.prototype.makeMessage=function(e,t,r,n){try{var o=this;function i(){return Promise.resolve(crypto.subtle.exportKey("jwk",o.sigPubKey)).then(function(r){return Promise.resolve(J(r)).then(function(r){return Promise.resolve(new _(e,s,t,Date.now()/1e3+o.defaultTTLSec|0,c).toCompactECDSAP256(u+"/"+r.slice(0,h),o.sigPrivKey)).then(function(e){if($){var t=W.fromCompact(e).toLogFormat();n&&(t.payload.body.jwe=a.toLogFormat(n)),t=X?JSON.stringify(t,null,2):t,console.log("makeMessage\n",t)}return e})})})}var s=(Date.now()/1e3|0)+"."+o.nextIDUniq++,u=L(o.address);t=L(t);var c=r||{},a=null,l=function(){if(n)return n.src=u,Promise.resolve(o.getKnownKeys(t)).then(function(e){return Promise.resolve(H.toECDHP256Pub(e.encPubKey)).then(function(r){var o=F.encryptECDHESP256,i=JSON.stringify(n);return Promise.resolve(J(e.encPubKey)).then(function(e){return Promise.resolve(o.call(F,r,i,t+"/"+e.slice(0,h))).then(function(e){c.jwe=(a=e).toCompact()})})})})}();return l&&l.then?l.then(i):i()}catch(e){return Promise.reject(e)}},Y.prototype.makeMessageClear=function(e,t,r,n){try{return(r=r||{}).kid=t,this.makeMessage(v.Clear,e,r,n)}catch(e){return Promise.reject(e)}},Y.prototype.makeMessageSigned=function(e,t,r){try{return t&&((r=r||{}).kid=optKid),this.makeMessage(v.Signed,e,r,null)}catch(e){return Promise.reject(e)}},Y.prototype.makeMessageEncrypted=function(e,t,r,n){try{return t&&((r=r||{}).kid=t),this.makeMessage(v.Encrypted,e,r,n)}catch(e){return Promise.reject(e)}},Y.prototype.makeMessagePublish=function(e,t,r,n,o){try{return(n=n||{}).kid=t,(o=o||{}).pkg=r,this.makeMessage(v.Publish,e,n,o)}catch(e){return Promise.reject(e)}},Y.prototype.makeMessageRequest=function(e,t,r,n,o){try{var i=this;return(n=n||{}).kid=t,n.noCache=r||!1,Promise.resolve(H.fromECDHP256Pub(i.encPubKey)).then(function(t){return n.encPubKey=t,i.makeMessage(v.Request,e,n,o)})}catch(e){return Promise.reject(e)}},Y.prototype.sendMessages=function(e){try{return Promise.resolve(this.req("POST","/v1/messages/send",{msgs:e})).then(function(e){var t=new q(e);return t.isError()?t:(t.body=t.body?t.body.map(function(e){return _.fromObj(e)}):[],t)})}catch(e){return Promise.reject(e)}},Y.prototype.fetchMessages=function(e,t,r,n){try{var o=this,i="/v1/messages/fetch",s={};e&&(s.min=e),t&&(s.max=t),r&&(s.order=r),n&&(s.limit=n);var u=W.forValuePayload(new V(o.address,o.address,o.address,[o.nixHost]).setExpire(300,300).withBody(s)).setTgtIat(i+"#jwt"),c=u.setKID;return Promise.resolve(o.curSigKID()).then(function(e){return Promise.resolve(c.call(u,e).toCompactECDSAP256(o.sigPrivKey)).then(function(e){return Promise.resolve(o.req("POST",i,{jwt:e})).then(function(e){return new q(e)})})})}catch(e){return Promise.reject(e)}},Y.prototype.fetchMessageStream=function(e,t,r,n,o,i,s,u){try{var c=this;(u=u?4:2*u)>3e4&&(u=3e4);var a="/v1/messages/listen",l={jti:c.reconnectID};e&&(l.min=e),t&&(l.max=t),r&&(l.order=r),n&&(l.limit=n);var y=W.forValuePayload(new V(c.address,c.address,c.address,[c.nixHost]).setExpire(300,300).withBody(l)).setTgtIat(a+"#jwt"),d=y.setKID;return Promise.resolve(c.curSigKID()).then(function(l){return Promise.resolve(d.call(y,l).toCompactECDSAP256(c.sigPrivKey)).then(function(l){var y=function(){!i||s&&s.cancelled||setTimeout(c.fetchMessageStream.bind(c,e,t,r,n,o,i,s),u)};c.reqRaw("POST",a,{jwt:l}).then(function(e){var t=e.body.getReader(),r="",n=function(e){var i=e.value;if(u=16,e.end)y();else if(s&&s.canceled)t.cancel();else{for(var a=B(i),l=a.indexOf("\n");l>=0;){r+=a.slice(0,l);try{o(JSON.parse(r))}catch(e){console.error("identity"+c.address+".fetchMessageStream() => onMessage exception",e)}r="",l=(a=a.slice(l+1)).indexOf("\n")}r+=a,t.read().then(n).catch(y)}};t.read().then(n).catch(y)}).catch(y)})})}catch(e){return Promise.reject(e)}},Object.defineProperties(Y.prototype,ee);var te=function(e){void 0===e&&(e={});var t=e.id;void 0===t&&(t=null);var r=e.routeAddress;void 0===r&&(r=null);var n=e.vaultAddress;void 0===n&&(n=null),this.route=r,this.vault=n,this.id=t,this.meta={},this.keys={},this.perms={}};te.fromObj=function(e){try{var t,r=new te;for(t in e)r[t]=e[t];r.keys={};var n=i(e.keys,function(t){return Promise.resolve(crypto.subtle.importKey("jwk",e.keys[t],{name:"AES-GCM"},!0,["encrypt","decrypt"])).then(function(e){r.keys[t]=e})});return n&&n.then?n.then(function(){return r}):r}catch(e){return Promise.reject(e)}},te.prototype.noPerms=function(){try{var e=this,t={route:e.route||void 0,vault:e.vault||void 0,id:e.id,meta:e.meta,keys:{}},r=i(e.keys,function(r){return Promise.resolve(crypto.subtle.exportKey("jwk",e.keys[r])).then(function(e){t.keys[r]=e})});return r&&r.then?r.then(function(){return t}):t}catch(e){return Promise.reject(e)}},te.prototype.createJWK=function(e){try{var t=this;return Promise.resolve(crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"])).then(function(r){if(!e){for(e=Object.keys(t.keys).length;""+e in t.keys;)e++;e=""+e}return t.keys[e]=r,t.getJWK(e)})}catch(e){return Promise.reject(e)}},te.prototype.addJWK=function(e,t,r){try{var n=this;return Promise.resolve(crypto.subtle.importKey("jwk",t,{name:"AES-GCM"},!0,["encrypt","decrypt"])).then(function(o){if(n.keys[e]=o,!r)return t.use="enc",t.kid=L(n.route||n.vault||"")+"/"+n.id+"/"+e,n.route&&n.vault&&(t.vault=L(n.vault)),n})}catch(e){return Promise.reject(e)}},te.prototype.getJWK=function(e){try{var t=this;return(e=(e=e.split("/"))[e.length-1])in t.keys?Promise.resolve(crypto.subtle.exportKey("jwk",t.keys[e])).then(function(r){return delete r.ext,delete r.jwk_ops,r.use="enc",r.kid=L(t.route||t.vault||"")+"/"+t.id+"/"+e,t.route&&t.vault&&(r.vault=L(t.vault)),r}):null}catch(e){return Promise.reject(e)}},te.prototype.removeJWK=function(e){delete this.keys[e]},te.prototype.clearJWKs=function(){this.keys={}},te.prototype.encrypt=function(e,t,r,n){try{if(!("string"==typeof t||t instanceof String))throw"value isn't a string - did you forget to encode?";if(!((e=(e=e.split("/"))[e.length-1])in this.keys))throw'no key named "'+e+'" found';var o=L(this.route||this.vault||"")+"/"+this.id+"/"+e,i=n||{};return this.route&&this.vault&&(i.vault=L(this.vault)),r&&(i.typ=r),Promise.resolve(F.encryptDirectAES256GCM(this.keys[e],t,o,i)).then(function(e){return e.toCompact()})}catch(e){return Promise.reject(e)}},te.prototype.decrypt=function(e){try{var t=this,r=F.fromCompact(e),n=r.getProtected().kid.split("/"),o=n[n.length-1];return Promise.resolve(t.getJWK(o)).then(function(e){if(!e)throw"content package "+t.id+" does not have a key "+o+" for this encrypted data";return Promise.resolve(r.decryptDirectAES256GCM(e))})}catch(e){return Promise.reject(e)}},te.prototype.addMeta=function(e,t){if(!("string"==typeof e||e instanceof String))throw"metadata keys must be strings";if(!("string"==typeof t||t instanceof String))throw"metadata values must be strings";return this.meta[e]=t,this},te.prototype.getMeta=function(e){return this.meta[e]},te.prototype.removeMeta=function(e){delete this.meta[e]},te.prototype.clearMeta=function(e){this.meta={}};var re=function(e){void 0===e&&(e={});var t=e.comms;void 0===t&&(t=null),this.comms=t,this.msgReceiveLoopRunning=!1,this.pkgListeners={},this.clearListeners={}},ne={address:{configurable:!0},name:{configurable:!0},type:{configurable:!0}};re.fromJSONFull=function(e){try{return Promise.resolve(Y.fromJSONFull(e)).then(function(e){return new re({comms:e})})}catch(e){return Promise.reject(e)}},re.prototype.toJSONFull=function(){try{return this.comms.toJSONFull()}catch(e){return Promise.reject(e)}},ne.address.get=function(){return this.comms.address},ne.name.get=function(){return this.comms.metaPublic.name},re.prototype.setName=function(e){try{return this.comms.metaPublic.name=e}catch(e){return Promise.reject(e)}},ne.type.get=function(){return this.comms.metaPublic.identityType},re.prototype.setType=function(e){try{return this.comms.metaPublic.identityType=e}catch(e){return Promise.reject(e)}},re.prototype.getSigPubJWK=function(){try{return Promise.resolve(H.fromECDSAP256Pub(this.comms.sigPubKey))}catch(e){return Promise.reject(e)}},re.prototype.getEncPubJWK=function(){try{return Promise.resolve(H.fromECDHP256Pub(this.comms.encPubKey))}catch(e){return Promise.reject(e)}},re.prototype.publishContentPackage=function(e,t){try{var r=this;return Promise.resolve(t.noPerms()).then(function(n){return Promise.resolve(r.comms.makeMessagePublish(e,t.id,n,null,{perms:t.perms})).then(function(e){return Promise.resolve(r.comms.sendMessages([e]))})})}catch(e){return Promise.reject(e)}},re.prototype.deleteContentPackage=function(e,t){try{var r=this;return Promise.resolve(r.comms.makeMessageClear(e,t)).then(function(e){return Promise.resolve(r.comms.sendMessages([e]))})}catch(e){return Promise.reject(e)}},re.prototype.fetchContentPackage=function(e,t){try{var r=this;return Promise.resolve(r.comms.makeMessageRequest(e,t)).then(function(n){return Promise.resolve(r.comms.sendMessages([n])).then(function(n){var o=!1;function i(n){return o?n:(r.msgReceiveLoopRunning||setTimeout(r.msgReceiveLoop.bind(r),5),new Promise(function(n,o){var i;i=N(e),r.pkgListeners[(e=i[0])+"/"+t]={call:n}}))}if(n.code<2e4||n.code>29999)throw n.err;var s=function(){if(20016===n.body[0].code)return Promise.resolve(r.comms.extractMessage(n.body[0].body[0].msg)).then(function(e){return o=!0,Promise.resolve(te.fromObj(e.body.jwe.pkg))})}();return s&&s.then?s.then(i):i(s)})})}catch(e){return Promise.reject(e)}},re.prototype.msgReceiveLoop=function(){try{var e=this;e.msgReceiveLoopRunning=!0;try{e.comms.fetchMessageStream(null,null,null,null,function(t){e.comms.extractMessage(t.msg).then(function(t){switch(t.type){case v.Publish:if(!t.body.jwe||!t.body.jwe.pkg)return;var r=N(t.src)[0]+"/"+t.body.kid,n=e.pkgListeners[r];return n&&te.fromObj(t.body.jwe.pkg).then(function(e){n.map(function(r){r.call(e,t)})}),void delete e.pkgListeners[r];case v.Clear:var o=N(t.src)[0]+"/"+t.body.kid,i=e.clearListeners[o];return i&&i.map(function(e){e.call(t.body.kid,t)}),void delete e.clearListeners[o]}}).catch(function(e){return console.error("processing err",e)})},!0)}finally{e.msgReceiveLoopRunning=!1}}catch(e){return Promise.reject(e)}},Object.defineProperties(re.prototype,ne);const oe=(e,t)=>t.some(t=>e instanceof t);let ie,se;const ue=new WeakMap,ce=new WeakMap,ae=new WeakMap,le=new WeakMap,ye=new WeakMap;let de={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return ce.get(e);if("objectStoreNames"===t)return e.objectStoreNames||ae.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return fe(e[t])},has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function fe(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,r)=>{const n=()=>{e.removeEventListener("success",o),e.removeEventListener("error",i)},o=()=>{t(fe(e.result)),n()},i=()=>{r(e.error),n()};e.addEventListener("success",o),e.addEventListener("error",i)});return t.then(t=>{t instanceof IDBCursor&&ue.set(t,e)}).catch(()=>{}),ye.set(t,e),t}(e);if(le.has(e))return le.get(e);const t=function(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(se||(se=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(he(this),e),fe(ue.get(this))}:function(...e){return fe(t.apply(he(this),e))}:function(e,...r){const n=t.call(he(this),e,...r);return ae.set(n,e.sort?e.sort():[e]),fe(n)}:(e instanceof IDBTransaction&&function(e){if(ce.has(e))return;const t=new Promise((t,r)=>{const n=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",i),e.removeEventListener("abort",i)},o=()=>{t(),n()},i=()=>{r(e.error),n()};e.addEventListener("complete",o),e.addEventListener("error",i),e.addEventListener("abort",i)});ce.set(e,t)}(e),oe(e,ie||(ie=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,de):e);var t}(e);return t!==e&&(le.set(e,t),ye.set(t,e)),t}const he=e=>ye.get(e);function ve(e,t,{blocked:r,upgrade:n,blocking:o}={}){const i=indexedDB.open(e,t),s=fe(i);return n&&i.addEventListener("upgradeneeded",e=>{n(fe(i.result),e.oldVersion,e.newVersion,fe(i.transaction))}),r&&i.addEventListener("blocked",()=>r()),o&&s.then(e=>e.addEventListener("versionchange",o)),s}const me=["get","getKey","getAll","getAllKeys","count"],pe=["put","add","delete","clear"],Pe=new Map;function ge(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(Pe.get(t))return Pe.get(t);const r=t.replace(/FromIndex$/,""),n=t!==r,o=pe.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!o&&!me.includes(r))return;const i=async function(e,...t){const i=this.transaction(e,o?"readwrite":"readonly");let s=i.store;n&&(s=s.index(t.shift()));const u=s[r](...t);return o&&await i.done,u};return Pe.set(t,i),i}de=(e=>({get:(t,r,n)=>ge(t,r)||e.get(t,r,n),has:(t,r)=>!!ge(t,r)||e.has(t,r)}))(de);var be="contentPkgPerms",Ce="addr",ke="perm",Ke="kid",Se="latestTS",we=function(){};we.forIdentity=function(e){void 0===e&&(e={});var t=e.identity;void 0===t&&(t=null);var r=e.dbName;void 0===r&&(r=null);try{var n=new we;n.identity=t,r||(r="nix."+t.address);var o=F.encryptECDHESP256,i=n.identity.comms.encPubKey;return Promise.resolve(H.randomAESGCM()).then(function(e){return Promise.resolve(o.call(F,i,JSON.stringify(e),"intermediateKey")).then(function(e){var t=e.toCompact();return Promise.resolve(ve(r,1,{upgrade:function(e,r,n,o){var i;if(!r||r<1){e.createObjectStore("identities",{keyPath:"addr"});var s=e.createObjectStore("globalPerms",{keyPath:"id",autoIncrement:!0});s.createIndex("addr","addr"),s.createIndex("perm","perm");var u=e.createObjectStore(be,{keyPath:"id",autoIncrement:!0});u.createIndex(Ce,Ce),u.createIndex(ke,ke),u.createIndex(Ke,Ke),e.createObjectStore("contentPkgs",{keyPath:"kid"}),e.createObjectStore("knownMsgIDs",{keyPath:"id"}),e.createObjectStore("configs",{keyPath:"key"}).add(((i={}).key="intermediateKey",i.value=t,i))}}})).then(function(e){return n.db=e,Promise.resolve(n.db.get("configs","intermediateKey")).then(function(e){function r(e){return Promise.resolve(n.getConfig(Se)).then(function(e){return n.latestTS=e,n.writeLatestTS=null,n})}t=e;var o=u(function(){var e=H.toAESGCMKey;return Promise.resolve(F.fromCompact(t.value).decryptECDHEP256(n.identity.comms.encPrivKey)).then(function(t){return Promise.resolve(e.call(H,JSON.parse(t))).then(function(e){n.key=e})})},function(e){throw"given key / password / jwk could not be used to unlock the store: "+e});return o&&o.then?o.then(r):r()})})})})}catch(e){return Promise.reject(e)}},we.prototype.setConfig=function(e,t){try{var r=this;return Promise.resolve(F.encryptDirectAES256GCM(r.key,t)).then(function(n){var o;return t=n.toCompact(),r.db.put("configs",((o={}).key=e,o.value=t,o))})}catch(e){return Promise.reject(e)}},we.prototype.getConfig=function(e){try{var t=this;return Promise.resolve(t.db.get("configs",e)).then(function(e){return e&&e.value?Promise.resolve(F.fromCompact(e.value).decryptDirectAES256GCM(t.key)):null})}catch(e){return Promise.reject(e)}},we.prototype.setAllowGlobal=function(e,t){var r;try{var n=this;return r=N(e),e=r[0],Promise.resolve(n.isAllowedGlobal(e,t)).then(function(r){var o;if(!r)return n.db.put("globalPerms",((o={}).addr=e,o.perm=t,o))})}catch(e){return Promise.reject(e)}},we.prototype.isAllowedGlobal=function(e,t){try{e=N(e)[0];var r=this.db.transaction("globalPerms").store.index("addr");return Promise.resolve(r.openCursor(e)).then(function(e){var r=!1,n=s(function(){return!r&&!!e},void 0,function(){return e.value.perm===t?(r=!0,!0):Promise.resolve(e.continue()).then(function(t){e=t})});return n&&n.then?n.then(function(e){return!!r&&e}):!!r&&n})}catch(e){return Promise.reject(e)}},we.prototype.setAllowContentPackage=function(e,t,r){var n;try{var o=this;return n=N(e),e=n[0],Promise.resolve(o.isAllowedContentPackage(e,t,r,!0)).then(function(n){var i;if(!n)return o.db.put(be,((i={})[Ce]=e,i[ke]=t,i[Ke]=r,i))})}catch(e){return Promise.reject(e)}},we.prototype.isAllowedContentPackage=function(e,t,r,n){try{var o=this;function i(n){var i;if(n)return!0;i=N(e),e=i[0];var u=o.db.transaction(be).store.index(Ke);return Promise.resolve(u.openCursor(r)).then(function(r){var n=!1,o=s(function(){return!n&&!!r},void 0,function(){return r.value[ke]===t&&r.value[Ce]===e?(n=!0,!0):Promise.resolve(r.continue()).then(function(e){r=e})});return o&&o.then?o.then(function(e){return!!n&&e}):!!n&&o})}return n?i(!n&&o.isAllowedGlobal(e,t)):Promise.resolve(!n&&o.isAllowedGlobal(e,t)).then(i)}catch(e){return Promise.reject(e)}},we.prototype.gatherContentPackagePerms=function(e){try{var t=this.db.transaction(be).store.index(Ke);return Promise.resolve(t.openCursor(e)).then(function(e){var t={},r=s(function(){return!!e},void 0,function(){var r=e.value[ke],n=e.value[Ce];return t[r]||(t[r]=[]),t[r].push(n),Promise.resolve(e.continue()).then(function(t){e=t})});return r&&r.then?r.then(function(){return t}):t})}catch(e){return Promise.reject(e)}},we.prototype.processedBefore=function(e,t){try{var r=this,n=e.length-9,o=e.slice(0,n);return r.latestTS=(Number(o)-120|0)+e.slice(n),Promise.resolve(r.db.get("knownMsgIDs",e+t)).then(function(n){var o;return!(!n||!n.id)||Promise.resolve(r.db.put("knownMsgIDs",(o={},o.id=e+t,o))).then(function(){return r.writeLatestTS||(r.writeLatestTS=setTimeout(function(){r.setConfig(Se,r.latestTS).then(function(){}),r.writeLatestTS=null},1e3)),!1})})}catch(e){return Promise.reject(e)}},we.prototype.getLatestTS=function(){return this.latestTS},we.prototype.setContentPackage=function(e,t){try{var r=this;return Promise.resolve(F.encryptDirectAES256GCM(r.key,t)).then(function(t){var n,o=t.toCompact();return r.db.put("contentPkgs",((n={}).kid=e,n.value=o,n))})}catch(e){return Promise.reject(e)}},we.prototype.getContentPackage=function(e){try{var t=this;return Promise.resolve(t.db.get("contentPkgs",e)).then(function(e){return e&&e.value?Promise.resolve(F.fromCompact(e.value).decryptDirectAES256GCM(t.key)):null})}catch(e){return Promise.reject(e)}},we.prototype.deleteContentPackage=function(e,t){try{return this.db.delete("contentPkgs",e)}catch(e){return Promise.reject(e)}},we.prototype.whichIdentitiesCan=function(e,t){try{var r=this,n={},o=r.db.transaction("globalPerms").store.index("perm");return Promise.resolve(o.openCursor(e)).then(function(i){function u(){return o=r.db.transaction(be).store.index(Ke),Promise.resolve(o.openCursor(t)).then(function(t){function r(){return Object.keys(n)}i=t;var o=s(function(){return!!i},void 0,function(){return i.value[ke]===e&&(n[i.value[Ce]]=!0),Promise.resolve(i.continue()).then(function(e){i=e})});return o&&o.then?o.then(r):r()})}var c=s(function(){return!!i},void 0,function(){return n[i.value.addr]=!0,Promise.resolve(i.continue()).then(function(e){i=e})});return c&&c.then?c.then(u):u()})}catch(e){return Promise.reject(e)}},we.prototype.deleteContentPackagePerms=function(e,t){try{var r=this.db.transaction(be,"readwrite").store.index(Ke);return Promise.resolve(r.openCursor(e)).then(function(e){var t=s(function(){return!!e},void 0,function(){return Promise.resolve(e.delete()).then(function(){return Promise.resolve(e.continue()).then(function(t){e=t})})});if(t&&t.then)return t.then(function(){})})}catch(e){return Promise.reject(e)}};var Ae=function(){};Ae.forIdentity=function(e){void 0===e&&(e={});var t=e.identity;void 0===t&&(t=null);var r=e.storage;void 0===r&&(r=null);try{function n(){return o.storage=r,o}var o=new Ae;o.identity=t;var i=function(){if(!r)return Promise.resolve(we.forIdentity({identity:t})).then(function(e){r=e})}();return i&&i.then?i.then(n):n()}catch(e){return Promise.reject(e)}},Ae.prototype.setAdminIdentity=function(e){try{var t=this,r=i(m,function(r){return Promise.resolve(t.storage.setAllowGlobal(e.address,m[r])).then(function(){})});return r&&r.then?r.then(function(){}):void 0}catch(e){return Promise.reject(e)}},Ae.prototype.fetchLoop=function(){try{var e=this;function i(){e.identity.comms.fetchMessageStream(e.storage.getLatestTS(),null,null,null,function(t){try{e.messageReceived(t).then(function(){})}catch(e){console.log("Vault: error processing msg:",t,"err:",e)}})}var s=[],u=function(e,o){var i;do{var s=e();if(s&&s.then){if(!n(s)){i=!0;break}s=s.v}var u=o();if(n(u)&&(u=u.v),!u)return s}while(!u.then);const c=new t,a=r.bind(null,c,2);return(i?s.then(l):u.then(y)).then(void 0,a),c;function l(t){for(s=t;n(u=o())&&(u=u.v),u;){if(u.then)return void u.then(y).then(void 0,a);if((s=e())&&s.then){if(!n(s))return void s.then(l).then(void 0,a);s=s.v}}r(c,1,s)}function y(t){if(t){do{if((s=e())&&s.then){if(!n(s))return void s.then(l).then(void 0,a);s=s.v}if(n(t=o())&&(t=t.v),!t)return void r(c,1,s)}while(!t.then);t.then(y).then(void 0,a)}else r(c,1,s)}}(function(){return Promise.resolve(e.identity.comms.fetchMessages(e.storage.getLatestTS(),null,"DESC",10)).then(function(t){var r=o(s=t,function(t){return Promise.resolve(e.messageReceived(s[t])).then(function(){})});if(r&&r.then)return r.then(function(){})})},function(){return s.length>=10});return u&&u.then?u.then(i):i()}catch(e){return Promise.reject(e)}},Ae.prototype.messageReceived=function(e){try{var t=this;return Promise.resolve(t.identity.comms.extractMessage(e.msg)).then(function(r){return Promise.resolve(t.storage.processedBefore(e.ts,r.id)).then(function(e){if(!e){switch(r.type){case v.Encrypted:return t.encryptedMessageReceived(r);case v.Signed:return t.signedMessageReceived(r);case v.Publish:return t.contentPackagePublishReceived(r);case v.Clear:return t.contentPackageClearReceived(r);case v.Request:return t.contentPackageRequestReceived(r)}throw"Unhandled message type "+r.type}})})}catch(e){return Promise.reject(e)}},Ae.prototype.signedMessageReceived=function(e){try{console.warn("not implemented :-D")}catch(e){return Promise.reject(e)}},Ae.prototype.encryptedMessageReceived=function(e){try{console.warn("not implemented :-D")}catch(e){return Promise.reject(e)}},Ae.prototype.contentPackagePublishReceived=function(e){try{var t=this;return Promise.resolve(t.storage.isAllowedContentPackage(e.src,m.ContentPkgRead,e.body.kid)).then(function(r){var n=!1;function o(r){var o=!1;if(n)return r;function i(r){if(o)return r;function n(){function r(){return t.respondContentPackagePublish(e.id,e.src,e.body.kid,e.body.jwe.pkg,e.body.jwe.perms)}var n=function(){if(e.body.jwe.perms)return Promise.resolve(t.updateContentPackagePerms(e.body.kid,e.body.jwe.perms,e.body.jwe.pkg)).then(function(){})}();return n&&n.then?n.then(r):r()}var i=function(){if(e.body.jwe.pkg)return Promise.resolve(t.storage.setContentPackage(e.body.kid,e.body.jwe.pkg)).then(function(){})}();return i&&i.then?i.then(n):n()}var s=e.body.jwe.perms&&Object.keys(e.body.jwe.perms).length>0?Promise.resolve(t.storage.isAllowedContentPackage(e.src,m.ContentPkgControl,e.body.kid)).then(function(r){if(!r)return o=!0,t.respondNotAllowedContentPackage(e.id,e.src,m.ContentPkgControl,e.body.kid)}):Promise.resolve(t.storage.isAllowedContentPackage(e.src,m.ContentPkgControl,e.body.kid)).then(function(r){var n=function(){if(r)return Promise.resolve(t.storage.gatherContentPackagePerms(e.body.kid)).then(function(t){e.body.jwe.perms=t})}();if(n&&n.then)return n.then(function(){})});return s&&s.then?s.then(i):i(s)}if(!r)return t.respondNotAllowedContentPackage(e.id,e.src,m.ContentPkgRead,e.body.kid);var i=function(){if(e.body.jwe.pkg)return Promise.resolve(t.storage.isAllowedContentPackage(e.src,m.ContentPkgWrite,e.body.kid)).then(function(r){if(!r)return n=!0,t.respondNotAllowedContentPackage(e.id,e.src,m.ContentPkgWrite,e.body.kid)})}();return i&&i.then?i.then(o):o(i)})}catch(e){return Promise.reject(e)}},Ae.prototype.contentPackageClearReceived=function(e){try{var t=this;return Promise.resolve(t.storage.isAllowedContentPackage(e.src,m.ContentPkgWrite,e.body.kid)).then(function(r){return r?Promise.resolve(t.storage.deleteContentPackage(e.body.kid)).then(function(){return Promise.resolve(t.clearContentPackageReaders(e.body.kid)).then(function(){return Promise.resolve(t.storage.isAllowedContentPackage(e.src,m.ContentPkgControl,e.body.kid)).then(function(r){function n(){return t.respondContentPackageClear(e.id,e.src,e.body.kid)}var o=function(){if(r)return Promise.resolve(t.storage.deleteContentPackagePerms(e.body.kid)).then(function(){})}();return o&&o.then?o.then(n):n()})})}):t.respondNotAllowedContentPackage(e.id,e.src,m.ContentPkgWrite,e.body.kid)})}catch(e){return Promise.reject(e)}},Ae.prototype.contentPackageRequestReceived=function(e){try{var t=this;return Promise.resolve(t.storage.isAllowedContentPackage(e.src,m.ContentPkgRead,e.body.kid)).then(function(r){return r?Promise.resolve(t.storage.getContentPackage(e.body.kid)).then(function(r){return t.respondContentPackagePublish(e.id,e.src,e.body.kid,r)}):t.respondNotAllowedContentPackage(e.id,e.src,m.ContentPkgRead,e.body.kid)})}catch(e){return Promise.reject(e)}},Ae.prototype.respondNotAllowedGeneral=function(e,t,r){try{var n=this;return Promise.resolve(n.identity.comms.makeMessageEncrypted(t,void 0,{respTo:e},{status:401})).then(function(e){return Promise.resolve(n.identity.comms.sendmEssages([e])).then(function(){})})}catch(e){return Promise.reject(e)}},Ae.prototype.respondNotAllowedContentPackage=function(e,t,r,n){try{var o=this;return Promise.resolve(o.identity.comms.makeMessageEncrypted(t,n,{respTo:e},{status:401})).then(function(e){return Promise.resolve(o.identity.comms.sendMessages([e])).then(function(){})})}catch(e){return Promise.reject(e)}},Ae.prototype.respondContentPackagePublish=function(e,t,r,n,o){try{var i=this,s={respTo:e};return o&&(s.perms=o),Promise.resolve(i.identity.comms.makeMessagePublish(t,r,n,s)).then(function(e){return Promise.resolve(i.identity.comms.sendMessages([e])).then(function(){})})}catch(e){return Promise.reject(e)}},Ae.prototype.respondContentPackageClear=function(e,t,r){try{var n=this;return Promise.resolve(n.identity.comms.makeMessageClear(t,r,{respTo:e})).then(function(e){return Promise.resolve(n.identity.comms.sendMessages([e])).then(function(){})})}catch(e){return Promise.reject(e)}},Ae.prototype.updateContentPackagePerms=function(e,t,r){try{var n=this;function o(){function o(){console.warn("not implemented :-D")}var s=t[m.ContentPkgRead],u=i(s,function(t){return Promise.resolve(n.storage.setAllowContentPackage(s[t],m.ContentPkgRead,e)).then(function(){return Promise.resolve(n.respondContentPackagePublish(void 0,s[t],e,r)).then(function(){})})});return u&&u.then?u.then(o):o()}var s=function(){if(!r)return Promise.resolve(n.storage.getContentPackage(e)).then(function(e){r=e})}();return s&&s.then?s.then(o):o()}catch(e){return Promise.reject(e)}},Ae.prototype.clearContentPackageReaders=function(e,t){try{var r=this;return Promise.resolve(r.storage.whichIdentitiesCan(m.ContentPkgRead,e)).then(function(n){function o(){return Promise.resolve(r.identity.comms.sendMessages(s)).then(function(){})}var s=[],u=i(n,function(o){if(n[o]!==t){var i=s,u=i.push;return Promise.resolve(r.identity.comms.makeMessageClear(n[o],e)).then(function(e){u.call(i,e);var t=function(){if(s.length>=8)return Promise.resolve(r.identity.comms.sendMessages(s.slice(0,8))).then(function(){s=s.slice(8)})}();if(t&&t.then)return t.then(function(){})})}});return u&&u.then?u.then(o):o()})}catch(e){return Promise.reject(e)}};var je=function(e){this.vaults={},this.vaultStorage=e||we};je.prototype.bootVaults=function(e,t){try{var r=this,n=o(e,function(n){return Promise.resolve(r.vaultStorage.forIdentity({identity:e[n]})).then(function(o){return Promise.resolve(Ae.forIdentity({identity:e[n],storage:o})).then(function(o){function s(){return Promise.resolve(o.fetchLoop()).then(function(){r.vaults[e[n].address]=o})}var u=i(t,function(e){if(t[e])return Promise.resolve(o.setAdminIdentity(t[e])).then(function(){})});return u&&u.then?u.then(s):s()})})});return n&&n.then?n.then(function(){}):void 0}catch(e){return Promise.reject(e)}};var Ie=function(e){void 0===e&&(e={});var t=e.defaultAPIKeyID;void 0===t&&(t=null);var r=e.defaultAPIKeySecret;void 0===r&&(r=null);var n=e.defaultAPIKeyJWT;void 0===n&&(n=null);var o=e.defaultNixURL;void 0===o&&(o="https://api.nix.software");var i=e.store;void 0===i&&(i=null);var s=e.vaultStore;if(void 0===s&&(s=null),this.defaultAPIKeyID=t,this.defaultAPIKeySecret=r,this.defaultAPIKeyJWT=n,this.defaultNixURL=o,this.store=i,this.vaultStore=s,!this.store)throw"store must be given - there is no default";this.store.setDefaults&&this.store.setDefaults({defaultAPIKeyID:this.defaultAPIKeyID,defaultAPIKeySecret:this.defaultAPIKeySecret,defaultAPIKeyJWT:this.defaultAPIKeyJWT,defaultNixURL:this.defaultNixURL}),this.vaultManager=new je(s)};Ie.prototype.init=function(){try{var e=this;function t(t){function r(t){function r(t){function r(t){var r;function n(){return Promise.resolve(e.store.getIdentitiesByType(f)).then(function(t){return Promise.resolve(e.vaultManager.bootVaults(t,[e.defaultIdentities[a],e.defaultIdentities[d]])).then(function(){return e})})}if(e.defaultNixURL=t,!e.defaultNixURL)throw"a defaultNixURL is required";e.defaultIdentities=((r={})[c]=null,r[a]=null,r[l]=null,r[y]=null,r[d]=null,r[f]=null,r);var o=i(e.defaultIdentities,function(t){return Promise.resolve(e.store.loadConfig("defaultIdentities."+t)).then(function(r){if(r)return Promise.resolve(e.store.getIdentityByAddress(r)).then(function(r){e.defaultIdentities[t]=r})})});return o&&o.then?o.then(n):n()}if(e.defaultAPIKeyJWT=t,!(e.defaultAPIKeyJWT||e.defaultAPIKeyID&&e.defaultAPIKeySecret))throw"an API key ID and secret or JWT is required";var n=e.defaultNixURL;return n?r(n):Promise.resolve(e.store.loadConfig("defaultAPIKeyID")).then(r)}e.defaultAPIKeySecret=t;var n=e.defaultAPIKeyJWT;return n?r(n):Promise.resolve(e.store.loadConfig("defaultAPIKeyJWT")).then(r)}e.defaultAPIKeyID=t;var n=e.defaultAPIKeySecret;return n?r(n):Promise.resolve(e.store.loadConfig("defaultAPIKeySecret")).then(r)}var r=e.defaultAPIKeyID;return r?t(r):Promise.resolve(e.store.loadConfig("defaultAPIKeyID")).then(t)}catch(e){return Promise.reject(e)}},Ie.prototype.newIdentity=function(e){void 0===e&&(e={});var t=e.type;void 0===t&&(t=c);var r=e.name;void 0===r&&(r="");var n=e.apiKeyID;void 0===n&&(n="");var o=e.apiKeySecret;void 0===o&&(o="");var i=e.apiKeyJWT;void 0===i&&(i="");var s=e.nixURL;void 0===s&&(s="");try{var u=this,l=new Y({apiKeyID:n||u.defaultAPIKeyID,apiKeySecret:o||u.defaultAPIKeySecret,apiKeyJWT:i||u.defaultAPIKeyJWT,nixURL:s||u.defaultNixURL});return l.metaPublic.name=r,l.metaPublic.identityType=t,Promise.resolve(l.register(t)).then(function(){var e=new re({comms:l});return Promise.resolve(u.store.storeIdentity(e)).then(function(){return t===f&&u.vaultManager.bootVaults([e],[u.defaultIdentities[a],u.defaultIdentities[d]]),e})})}catch(e){return Promise.reject(e)}},Ie.prototype.newContentPackage=function(e){try{var t=this;function r(){return new te({id:e,routeAddress:t.getDefaultIdentityAddress(y),vaultAddress:t.getDefaultIdentityAddress(f)})}var n=function(){if(!e)return Promise.resolve(g()).then(function(t){e=t})}();return n&&n.then?n.then(r):r()}catch(e){return Promise.reject(e)}},Ie.prototype.encrypt=function(e){try{var t=this;return Promise.resolve(t.newContentPackage()).then(function(r){return Promise.resolve(r.createJWK()).then(function(n){return Promise.resolve(r.encrypt(n.kid,e)).then(function(e){var n=t.getDefaultIdentity(a),o=t.getDefaultIdentity(f);return Promise.resolve(n.publishContentPackage(o.address,r)).then(function(){return e})})})})}catch(e){return Promise.reject(e)}},Ie.prototype.decrypt=function(e){try{var t=F.fromCompact(e).getProtected().kid.split("/"),r=t[0],n=t[1],o=this.getDefaultIdentity(a);return Promise.resolve(o.fetchContentPackage(r,n)).then(function(t){return Promise.resolve(t.decrypt(e))})}catch(e){return Promise.reject(e)}},Ie.prototype.decryptAll=function(e){try{var t,r=e.split(p),n=[];for(t=1;t<r.length;t+=2)n.push(this.decrypt(r[t]));return Promise.resolve(Promise.all(n)).then(function(e){for(var t=1;t<r.length;t+=2)r[t]=e[(t-1)/2];return r.join("")})}catch(e){return Promise.reject(e)}},Ie.prototype.addIdentity=function(e){try{return Promise.resolve(this.store.storeIdentity(e)).then(function(){})}catch(e){return Promise.reject(e)}},Ie.prototype.getIdentityByName=function(e){try{return this.store.getIdentityByName(e)}catch(e){return Promise.reject(e)}},Ie.prototype.getOrCreateIdentityByName=function(e,t,r){try{var n=this;return Promise.resolve(n.getIdentityByName(e)).then(function(o){var i=function(){if(!o)return Promise.resolve(n.newIdentity({name:e,type:t})).then(function(e){o=e;var t=function(){if(!r)return Promise.resolve(n.setDefaultIdentity(o)).then(function(){})}();if(t&&t.then)return t.then(function(){})})}();return i&&i.then?i.then(function(){return o}):o})}catch(e){return Promise.reject(e)}},Ie.prototype.getIdentityByAddress=function(e){try{return this.store.getIdentityByAddress(e)}catch(e){return Promise.reject(e)}},Ie.prototype.setDefaultIdentity=function(e){try{var t=this;return Promise.resolve(t.store.storeIdentity(e)).then(function(){return Promise.resolve(t.store.storeConfig("defaultIdentities."+e.type,e.address)).then(function(){t.defaultIdentities[e.type]=e})})}catch(e){return Promise.reject(e)}},Ie.prototype.getDefaultIdentity=function(e){return this.defaultIdentities[e]},Ie.prototype.getDefaultIdentityAddress=function(e){var t=this.getDefaultIdentity(e);return t?t.address:null};var De=function(){};De.fromPasswordKeyOrJWK=function(e){void 0===e&&(e={});var t=e.password;void 0===t&&(t=null);var r=e.key;void 0===r&&(r=null);var n=e.jwk;void 0===n&&(n=null);var o=e.optName;void 0===o&&(o="nix.localEncryptedStore");try{function i(){function e(){if(!s.key)throw"key, password, or JWK is required";if("AES-GCM"!==s.key.algorithm.name||256!==s.key.algorithm.length)throw"unsupported key - only AES-GCM 256 - "+JSON.stringify(s.key.algorithm);return s.startDB()}var t=function(){if(n)return Promise.resolve(H.toAESGCMKey(s.jwk)).then(function(e){s.key=e})}();return t&&t.then?t.then(e):e()}var s=new De;s.dbName=o,s.key=r;var u=function(){if(t)return Promise.resolve(F.pbkdf2(t,"jweStore")).then(function(e){s.key=e})}();return u&&u.then?u.then(i):i()}catch(e){return Promise.reject(e)}},De.prototype.startDB=function(){try{var e=this;e.dbName=e.dbName||"nix.localEncryptedStore";var t=F.encryptDirectAES256GCM,r=e.key;return Promise.resolve(H.randomAESGCM()).then(function(n){return Promise.resolve(t.call(F,r,JSON.stringify(n),"intermediateKey")).then(function(t){var r=t.toCompact();return Promise.resolve(ve(e.dbName,1,{upgrade:function(e,t,n,o){if(!t||t<1){var i=e.createObjectStore("identities",{keyPath:"address"});i.createIndex("name","name"),i.createIndex("type","type"),e.createObjectStore("configs",{keyPath:"key"}).add({key:"intermediateKey",value:r})}}})).then(function(t){return e.db=t,Promise.resolve(e.db.get("configs","intermediateKey")).then(function(t){r=t;var n=u(function(){var t=H.toAESGCMKey;return Promise.resolve(F.fromCompact(r.value).decryptDirectAES256GCM(e.key)).then(function(r){return Promise.resolve(t.call(H,JSON.parse(r))).then(function(t){e.key=t})})},function(e){throw"given key / password / jwk could not be used to unlock the store: "+e});return n&&n.then?n.then(function(t){return e}):e})})})})}catch(e){return Promise.reject(e)}},De.prototype.storeIdentity=function(e){try{var t=this;return Promise.resolve(e.toJSONFull()).then(function(r){var n=t.db,o=n.put,i=e.type,s=e.name,u=e.address;return Promise.resolve(F.encryptDirectAES256GCM(t.key,r,e.address)).then(function(e){var t;return o.call(n,"identities",((t={}).address=u,t.name=s,t.type=i,t.JWE=e.toCompact(),t))})})}catch(e){return Promise.reject(e)}},De.prototype.getIdentitiesByType=function(e){try{var t=this;return Promise.resolve(t.db.getAllFromIndex("identities","type",e)).then(function(e){if(!e)return null;var r=[],n=o(e,function(n){return Promise.resolve(F.fromCompact(e[n].JWE).decryptDirectAES256GCM(t.key)).then(function(e){var t=r.push;return Promise.resolve(re.fromJSONFull(e)).then(function(e){t.call(r,e)})})});return n&&n.then?n.then(function(){return r}):r})}catch(e){return Promise.reject(e)}},De.prototype.getIdentityByName=function(e){try{var t=this;return Promise.resolve(t.db.getFromIndex("identities","name",e)).then(function(e){return e&&e.JWE?Promise.resolve(F.fromCompact(e.JWE).decryptDirectAES256GCM(t.key)).then(function(e){return re.fromJSONFull(e)}):null})}catch(e){return Promise.reject(e)}},De.prototype.getIdentityByAddress=function(e){try{var t=this;return Promise.resolve(t.db.get("identities",e)).then(function(e){return e&&e.JWE?Promise.resolve(F.fromCompact(e.JWE).decryptDirectAES256GCM(t.key)).then(function(e){return re.fromJSONFull(e)}):null})}catch(e){return Promise.reject(e)}},De.prototype.storeConfig=function(e,t){try{var r=this.db,n=r.put;return Promise.resolve(F.encryptDirectAES256GCM(this.key,JSON.stringify(t),e)).then(function(t){var o;return n.call(r,"configs",((o={}).key=e,o.JWE=t.toCompact(),o))})}catch(e){return Promise.reject(e)}},De.prototype.loadConfig=function(e){try{var t=this;return Promise.resolve(t.db.get("configs",e)).then(function(e){return e&&e.JWE?Promise.resolve(F.fromCompact(e.JWE).decryptDirectAES256GCM(t.key)).then(JSON.parse):null})}catch(e){return Promise.reject(e)}};var Ee=function(e){function t(){e.call(this)}return e&&(t.__proto__=e),(t.prototype=Object.create(e&&e.prototype)).constructor=t,t.fromPassword=function(e){try{var r=new t;if(!e)throw"password is required";return r.password=e,Promise.resolve(F.pbkdf2(e,"jweStore")).then(function(e){return r.key=e,r.startDB()})}catch(e){return Promise.reject(e)}},t.prototype.setDefaults=function(e){void 0===e&&(e={});var t=e.defaultAPIKeyID;void 0===t&&(t=null);var r=e.defaultAPIKeySecret;void 0===r&&(r=null);var n=e.defaultAPIKeyJWT;void 0===n&&(n=null);var o=e.defaultNixURL;void 0===o&&(o=null),this.defaultAPIKeyID=t,this.defaultAPIKeySecret=r,this.defaultAPIKeyJWT=n,this.defaultNixURL=o,this.defaultsSet=!0},t.prototype.storeIdentity=function(t){try{var r=this;return Promise.resolve(_identity$comms.setRecovery(_identity$comms$build)).then(function(){return e.prototype.storeIdentity.call(r,t)})}catch(e){return Promise.reject(e)}},t.prototype.getIdentityByAddress=function(t){try{var r=this;return Promise.resolve(e.prototype.getIdentityByAddress.call(r,t)).then(function(e){if(e)return e;if(!r.defaultsSet)return null;var n=u(function(){var e=new Y({apiKeyID:r.defaultAPIKeyID,apiKeySecret:r.defaultAPIKeySecret,apiKeyJWT:r.defaultAPIKeyJWT,nixURL:r.defaultNixURL});return Promise.resolve(e.recover(t,r.password,!0)).then(function(){return new re({comms:e})})},function(){return null});return n&&n.then?n.then(function(){return null}):null})}catch(e){return Promise.reject(e)}},t}(De),xe={JWE:F,JWS:W,JWK:H,JWT:V},Me={LocalEncryptedStore:De,RecoveryAndLocalEncryptedStore:Ee},Te={logMakeMessage:function(e){return void 0!==e&&($=e),$},logExtractMessage:function(e){return void 0!==e&&(Q=e),Q}};e.Client=Ie,e.ContentPackage=te,e.Identity=re,e.IdentityComms=Y,e.IdentityCommsMessage=_,e.IdentityCommsResponse=q,e.IdentityMetaPrivate=Z,e.IdentityMetaPublic=z,e.jose=xe,e.stores=Me,e.constants=P,e.util=G,e.debug=Te});
//# sourceMappingURL=nix-sdk.umd.js.map
